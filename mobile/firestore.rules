rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // Helper: auth email lowercased (for invite matching)
    function myEmail() {
      return request.auth.token.email != null
        ? request.auth.token.email.lower()
        : "";
    }

    // =========================================================
    // ADMIN HELPERS (must be defined before use in root matches)
    // =========================================================
    function isSuperAdminOfSociety(societyId) {
      return signedIn()
        && societyId is string
        && exists(/databases/$(database)/documents/societies/$(societyId)/members/$(request.auth.uid))
        && get(/databases/$(database)/documents/societies/$(societyId)/members/$(request.auth.uid)).data.active == true
        && get(/databases/$(database)/documents/societies/$(societyId)/members/$(request.auth.uid)).data.systemRole == "super_admin";
    }

    function isAdminOfSociety(societyId) {
      return signedIn()
        && societyId is string
        && exists(/databases/$(database)/documents/societies/$(societyId)/members/$(request.auth.uid))
        && get(/databases/$(database)/documents/societies/$(societyId)/members/$(request.auth.uid)).data.active == true
        && (
          get(/databases/$(database)/documents/societies/$(societyId)/members/$(request.auth.uid)).data.systemRole == "admin"
          || get(/databases/$(database)/documents/societies/$(societyId)/members/$(request.auth.uid)).data.systemRole == "super_admin"
        );
    }

    // ✅ Global Super Admin (root pointer check)
    // Used for privileged root collections like public_societies
    function isGlobalSuperAdmin() {
      return signedIn()
        && exists(/databases/$(database)/documents/members/$(request.auth.uid))
        && get(/databases/$(database)/documents/members/$(request.auth.uid)).data.systemRole == "super_admin"
        && get(/databases/$(database)/documents/members/$(request.auth.uid)).data.active == true;
    }

    // ============================================
    // ROOT POINTER: members/{uid}
    // ============================================
    match /members/{uid} {

      // NOTE: Kept as-is to avoid changing existing behavior
      allow read: if signedIn();

      allow create: if signedIn()
        && request.resource.data.uid == uid
        && request.resource.data.systemRole in ["admin", "super_admin", "guard", "resident"]
        && (request.resource.data.active == true || request.resource.data.active == false)
        && request.resource.data.societyId is string
        && (
          request.auth.uid == uid
          || isAdminOfSociety(request.resource.data.societyId)
          || isSuperAdminOfSociety(request.resource.data.societyId)
        );

      allow update: if signedIn() && (
        request.auth.uid == uid
        || (
          (resource.data.societyId is string && (isAdminOfSociety(resource.data.societyId) || isSuperAdminOfSociety(resource.data.societyId)))
          || (request.resource.data.societyId is string && (isAdminOfSociety(request.resource.data.societyId) || isSuperAdminOfSociety(request.resource.data.societyId)))
        )
      );

      allow delete: if false;
    }

    // Helpers for society membership under societies/{societyId}/members/{uid}
    function memberPath(societyId) {
      return /databases/$(database)/documents/societies/$(societyId)/members/$(request.auth.uid);
    }

    function isMember(societyId) {
      return signedIn() && exists(memberPath(societyId));
    }

    function member(societyId) {
      return get(memberPath(societyId));
    }

    function activeMember(societyId) {
      return isMember(societyId) && member(societyId).data.active == true;
    }

    function isAdmin(societyId) {
      return activeMember(societyId)
        && (member(societyId).data.systemRole == "admin"
            || member(societyId).data.systemRole == "super_admin");
    }

    function isSuperAdmin(societyId) {
      return activeMember(societyId)
        && member(societyId).data.systemRole == "super_admin";
    }

    function isGuard(societyId) {
      return activeMember(societyId)
        && member(societyId).data.systemRole == "guard";
    }

    function isResident(societyId) {
      return activeMember(societyId)
        && member(societyId).data.systemRole == "resident";
    }

    function canReadMemberDoc(societyId, uid) {
      return signedIn()
        && (
          (request.auth.uid == uid
            && exists(/databases/$(database)/documents/societies/$(societyId)/members/$(uid)))
          || isAdmin(societyId)
        );
    }

    // ✅ Allow society creator to re-run creation until membership exists
    function isCreatorBootstrappingSociety(societyId) {
      return signedIn()
        && resource.data.createdByUid == request.auth.uid
        && !exists(/databases/$(database)/documents/societies/$(societyId)/members/$(request.auth.uid))
        && request.resource.data.createdByUid == resource.data.createdByUid;
    }

    // ------------------------
    // Societies
    // ------------------------
    match /societies/{societyId} {

      allow create: if signedIn()
        && request.resource.data.createdByUid == request.auth.uid
        && request.resource.data.active == true;

      allow read: if activeMember(societyId);

      allow update: if isAdmin(societyId) || isCreatorBootstrappingSociety(societyId);

      allow delete: if isAdmin(societyId);

      match /members/{uid} {

        allow create: if signedIn()
          && request.resource.data.uid == uid
          && request.resource.data.societyId == societyId
          && (request.resource.data.active == true || request.resource.data.active == false)
          && request.resource.data.systemRole in ["admin", "super_admin", "guard", "resident"]
          && (uid == request.auth.uid || isAdmin(societyId));

        allow read: if signedIn()
          && (
            uid == request.auth.uid
            || isAdmin(societyId)
            || (activeMember(societyId) && member(societyId).data.systemRole == "guard")
          );

        allow update: if signedIn() && (
          (
            uid == request.auth.uid
            && member(societyId).data.systemRole == "guard"
          )
          || (
            uid == request.auth.uid
            && resource.data.active == true
            && request.resource.data.active == false
            && request.resource.data.uid == resource.data.uid
            && request.resource.data.societyId == resource.data.societyId
            && request.resource.data.systemRole == resource.data.systemRole
          )
          || (
            uid == request.auth.uid
            && request.resource.data.uid == resource.data.uid
            && request.resource.data.societyId == resource.data.societyId
            && request.resource.data.systemRole == resource.data.systemRole
            && request.resource.data.active == resource.data.active
          )
          || isAdmin(societyId)
        );

        allow delete: if isAdmin(societyId);
      }

      match /invites/{inviteKey} {
        allow get: if isAdmin(societyId)
          || (signedIn()
              && request.auth.token.email != null
              && resource.data.email is string
              && resource.data.email.lower() == myEmail());

        allow list: if signedIn()
          && request.auth.token.email != null
          && resource.data.email is string
          && resource.data.email.lower() == myEmail();

        allow create: if isAdmin(societyId)
          && request.resource.data.status == "pending"
          && request.resource.data.active == true
          && request.resource.data.email is string
          && request.resource.data.systemRole in ["guard", "resident", "admin", "super_admin"];

        allow update: if signedIn()
          && request.auth.token.email != null
          && resource.data.status == "pending"
          && resource.data.active == true
          && resource.data.email is string
          && resource.data.email.lower() == myEmail()
          && request.resource.data.status == "claimed"
          && request.resource.data.claimedByUid == request.auth.uid;

        allow delete: if isAdmin(societyId);
      }

      match /notices/{id} {
        allow read: if activeMember(societyId);
        allow create, update, delete: if isAdmin(societyId);
      }

      match /complaints/{id} {
        allow read: if activeMember(societyId)
          && (
            isAdmin(societyId)
            || member(societyId).data.systemRole == "guard"
            || (!("visibility" in resource.data) || resource.data.visibility != "personal")
            || resource.data.residentUid == request.auth.uid
          );
        allow create: if activeMember(societyId)
          && (!("visibility" in request.resource.data) || request.resource.data.visibility in ["general", "personal"]);
        allow update, delete: if isAdmin(societyId);
      }

      match /sos_requests/{id} {
        allow create: if activeMember(societyId);

        allow read: if activeMember(societyId)
          && (
            member(societyId).data.systemRole in ["admin", "super_admin", "guard"]
            || resource.data.residentId == request.auth.uid
          );

        allow update: if activeMember(societyId)
          && member(societyId).data.systemRole in ["admin", "super_admin", "guard"];
        allow delete: if false;
      }

      match /violations/{id} {
        allow create: if isGuard(societyId)
          && request.resource.data.guardUid == request.auth.uid
          && request.resource.data.keys().hasAll(["guardUid", "flatNo", "violationType", "createdAt", "updatedAt"])
          && request.resource.data.violationType in ["PARKING", "FIRE_LANE", "OTHER"];
        allow read: if activeMember(societyId)
          && (
            isAdmin(societyId)
            || (isGuard(societyId) && resource.data.guardUid == request.auth.uid)
            || (isResident(societyId) && resource.data.flatNo != null && member(societyId).data.flatNo != null && resource.data.flatNo.upper() == member(societyId).data.flatNo.upper())
          );
        allow update, delete: if isAdmin(societyId);
      }

      match /visitors/{id} {
        allow read: if activeMember(societyId);
        allow create: if activeMember(societyId)
          && member(societyId).data.systemRole == "guard"
          && request.resource.data.guard_uid == request.auth.uid
          && request.resource.data.status == "PENDING";
        allow update: if activeMember(societyId)
          && (
            isAdmin(societyId)
            || (
              member(societyId).data.systemRole == "resident"
              && resource.data.flat_no.upper() == member(societyId).data.flatNo.upper()
              && request.resource.data.status in ["APPROVED", "REJECTED"]
              && request.resource.data.approved_by == request.auth.uid
            )
          );
        allow delete: if isAdmin(societyId);
      }

      match /residentSignups/{id} {
        allow create: if request.resource.data.status == "PENDING"
          && request.resource.data.society_id == societyId
          && request.resource.data.keys().hasAll(["name", "email", "phone", "flat_no", "password", "signup_id", "society_id"]);

        allow read: if isAdmin(societyId);

        allow update: if isAdmin(societyId)
          && (
            request.resource.data.status in ["APPROVED", "REJECTED"]
            && (request.resource.data.keys().hasAny(["approved_by", "rejected_by"]))
          );

        allow delete: if false;
      }

      match /flats/{id} {
        allow read: if activeMember(societyId);
        allow create, update, delete: if isAdmin(societyId);
      }

      match /{col}/{doc} {
        allow read, write: if false;
      }
    }

    // ------------------------
    // PUBLIC SOCIETY DIRECTORY (root collection: public_societies)
    // - Readable by signed-in users (active only)
    // - Writable ONLY by Global SUPER_ADMIN (as requested)
    // ------------------------
    match /public_societies/{pubSocietyId} {

      allow read: if signedIn() && resource.data.active == true;

      // ✅ SuperAdmin-only create/update/delete
      allow create, update, delete: if isGlobalSuperAdmin();

      match /units/{unitId} {
        allow read: if signedIn() && resource.data.active == true;
        allow write: if false;
      }

      match /join_requests/{uid} {
        function isSelf() {
          return signedIn() && request.auth.uid == uid;
        }
        function isSocietyAdmin() {
          return isAdmin(pubSocietyId);
        }

        allow create: if isSelf()
          && request.resource.data.uid == request.auth.uid
          && request.resource.data.status == "PENDING";

        allow get: if isSelf() || isSocietyAdmin();
        allow list: if isSocietyAdmin();

        allow update: if (
            isSelf()
            && resource.data.status == "PENDING"
            && request.resource.data.diff(resource.data).changedKeys().hasOnly(
              ["name", "unitLabel", "residencyType"]
            )
          )
          || isSocietyAdmin();

        allow delete: if isSocietyAdmin();
      }
    }

    // society code mapping for "join by code"
    match /societyCodes/{code} {
      allow read: if true;

      allow create: if signedIn()
        && request.resource.data.createdByUid == request.auth.uid
        && request.resource.data.active == true;

      allow update, delete: if false;
    }

    // unique_phones/{phoneHash}
    match /unique_phones/{phoneHash} {
      allow read, write: if signedIn();
    }

    // Guard join codes
    match /guard_join_codes/{code} {
      allow read: if true;
      allow create: if signedIn() && isAdmin(request.resource.data.societyId);
      allow update, delete: if signedIn() && isAdmin(resource.data.societyId);
    }

    // PHONE INDEX
    match /phone_index/{phone} {
      allow read: if signedIn();

      allow create, update: if signedIn()
        && request.auth.token.phone_number != null
        && phone == request.auth.token.phone_number
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.societyId is string
        && request.resource.data.systemRole is string
        && (request.resource.data.active == true || request.resource.data.active == false);

      allow delete: if false;
    }

    // Default deny everything else (KEEP THIS LAST)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
